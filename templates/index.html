<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卡密管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card-item {
            margin-bottom: 10px;
        }
        .copy-btn {
            cursor: pointer;
        }
        .copy-btn:hover {
            color: #0d6efd;
        }
        .countdown {
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container card-container">
        <h1 class="text-center mb-4">卡密管理系统</h1>
        
        <!-- 添加卡密表单 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">添加新卡密</h5>
                <form action="{{ url_for('add_card') }}" method="POST" class="row g-3">
                    <div class="col-auto">
                        <input type="number" class="form-control" name="minutes" placeholder="有效时间（分钟）" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">生成卡密</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- API使用说明 -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">API 使用说明</h5>
                <p class="card-text">验证卡密接口：<code>GET /api/verify_card/&lt;card_key&gt;</code></p>
                <p class="card-text">示例：<code>http://localhost:5000/api/verify_card/your_card_key</code></p>
            </div>
        </div>

        <!-- 卡密列表 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">卡密列表</h5>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>卡密</th>
                                <th>时长（分钟）</th>
                                <th>创建时间</th>
                                <th>状态</th>
                                <th>剩余时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for card in cards %}
                            <tr>
                                <td>
                                    <code>{{ card.card_key }}</code>
                                    <i class="copy-btn bi bi-clipboard ms-2" onclick="copyToClipboard('{{ card.card_key }}')" title="复制卡密"></i>
                                </td>
                                <td>{{ card.minutes }}</td>
                                <td>{{ card.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    {% if not card.is_used %}
                                        <span class="badge bg-success">未使用</span>
                                    {% elif card.is_used and card.used_at %}
                                        <span class="badge bg-warning" id="status-{{ card.id }}" 
                                              data-used-at="{{ card.used_at.isoformat() }}"
                                              data-minutes="{{ card.minutes }}">使用中</span>
                                    {% else %}
                                        <span class="badge bg-danger">已过期</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if card.is_used and card.used_at %}
                                        <span class="countdown" id="countdown-{{ card.id }}">计算中...</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <form action="{{ url_for('delete_card', card_id=card.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确定要删除这个卡密吗？')">删除</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('卡密已复制到剪贴板！');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }

        function updateCountdown() {
            const now = new Date();
            document.querySelectorAll('[id^="status-"]').forEach(statusElement => {
                const id = statusElement.id.split('-')[1];
                const usedAt = new Date(statusElement.dataset.usedAt);
                const minutes = parseInt(statusElement.dataset.minutes);
                const expirationTime = new Date(usedAt.getTime() + minutes * 60000);
                const countdownElement = document.getElementById(`countdown-${id}`);
                
                if (now >= expirationTime) {
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = '已过期';
                    if (countdownElement) {
                        countdownElement.textContent = '已过期';
                    }
                } else {
                    const remainingTime = expirationTime - now;
                    const remainingHours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const remainingSeconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                    
                    if (countdownElement) {
                        countdownElement.textContent = `${remainingHours}时${remainingMinutes}分${remainingSeconds}秒`;
                    }
                }
            });
        }

        // 每秒更新倒计时
        setInterval(updateCountdown, 1000);
        // 页面加载时立即更新一次
        updateCountdown();
    </script>
</body>
</html> 